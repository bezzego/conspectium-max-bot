# conspectium-max-bot

Чат-бот | Mini App для платформы MAX

## Backend (FastAPI + PostgreSQL)

### Быстрый старт

```bash
# Установить зависимости
poetry install

# Скопировать переменные окружения
cp .env.example .env

# Отредактировать .env (БД, Telegram Bot Token, GOOGLE_API_KEY и т.д.)

# Применить миграции
poetry run alembic upgrade head

# Запустить сервер
poetry run uvicorn app.main:app --reload
```

### Основные возможности
- Авторизация пользователей через Telegram Mini App (валидация `initData`, выдача JWT).
- Загрузка и хранение аудио, подготовка транскрипта.
- Генерация конспекта и теста с помощью Google Gemini (`gemini-2.5-flash`).
- Поддержка двух вариантов конспекта (сжатый и полный) с выбором прямо в интерфейсе.
- Управление сохранёнными тестами: список, переименование, быстрый запуск без перезагрузки страницы.
- Асинхронные задачи генерации (фоновая обработка, трекинг состояния).
- REST API для управления конспектами, тестами и статусом задач.

### Модульная структура
- `app/core` — конфигурация, настройки.
- `app/db` — сессия БД, инициализация.
- `app/models` — SQLAlchemy модели и перечисления.
- `app/schemas` — Pydantic-схемы запросов/ответов.
- `app/api` — роуты FastAPI.
- `app/services` — сервисы (Telegram auth, генерация с Gemini, работа с файлами).
- `alembic/` — миграции базы данных.

### Полезные команды
- `poetry run pytest` — тесты.
- `poetry run ruff check .` — статический анализ.
- `poetry run black .` — форматирование.

### Работа с фронтом
- После запуска сервера перейдите на `http://127.0.0.1:8000/front/html/main.html`.
- Веб-приложение теперь требует регистрацию через онбординг (welcome modal). Для быстрой локальной проверки можно вызвать `/api/auth/register` вручную для создания тестового пользователя.
- Все списки (конспекты, тесты) подгружаются из БД; создание конспектов и тестов выполняется через реальный API.
- Страницы:
  - `main.html` — главная, просмотр последних конспектов, загрузка аудио.
  - `conspect_create.html` — генерация конспекта из аудио или текста.
  - `test_list.html` — список сохранённых тестов с быстрым запуском и переименованием.
  - `choose_test.html` — выбор конспекта и запуск генерации нового теста.
- `test.html?quizId=<id>` — прохождение реального теста из базы.

### Интеграция с MAX Bot и Gemini

1. Добавьте в `.env` (при необходимости обновите под свои значения):
   ```
   MAX_BOT_TOKEN=<токен бота из кабинета MAX>
   MAX_MINI_APP_URL=https://<публичный-домен>/front/html/main.html
   MAX_WELCOME_MESSAGE=Привет! Я бот Конспектиума. Нажми кнопку ниже, чтобы открыть мини-приложение.
   MAX_WELCOME_BUTTON_TEXT=Открыть Конспектиум
   GOOGLE_API_KEY=<ключ для аудио-конспектов>
   GOOGLE_API_KEY_TEXT=<ключ для текстовых конспектов>
   ```

2. Разрешите доступ к локальному бэкенду (например, `ngrok http 8000`) и укажите в кабинете MAX адрес 
   вебхука `https://<публичный-домен>/api/max/webhook` и URL мини-приложения (он же `MAX_MINI_APP_URL`).

3. После перезапуска сервера бот автоматически отправит приветствие с кнопкой запуска мини-приложения при `/start`. 
   При генерации конспектов по аудио используется основной ключ Gemini, а при создании конспектов из текста — 
   `GOOGLE_API_KEY_TEXT`.
тест