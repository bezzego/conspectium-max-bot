name: Telegram Notifications

on:
  push:
  pull_request:
  issues:
    types: [opened, closed, reopened, edited]
  pull_request_review:
    types: [submitted]
  release:
    types: [published, created, edited]
  create:
  delete:
  fork:
  watch:
    types: [started]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram message
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_IDS: ${{ secrets.TG_CHAT_IDS }}
        run: |
          set -e

          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"

          # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ MarkdownV2 (ÑƒÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²Ð¾Ðµ Ð¸ Ð¿Ð¾Ð»Ð½Ð¾Ðµ)
          escape() {
            printf '%s' "$1" | sed \
              -e 's/\\/\\\\/g' \
              -e 's/_/\\_/g' \
              -e 's/\*/\\*/g' \
              -e 's/\[/\\[/g' \
              -e 's/\]/\\]/g' \
              -e 's/(/\\(/g' \
              -e 's/)/\\)/g' \
              -e 's/~/\\~/g' \
              -e 's/`/\\`/g' \
              -e 's/>/\\>/g' \
              -e 's/#/\\#/g' \
              -e 's/\+/\\+/g' \
              -e 's/-/\\-/g' \
              -e 's/=/\\=/g' \
              -e 's/|/\\|/g' \
              -e 's/{/\\{/g' \
              -e 's/}/\\}/g' \
              -e 's/\./\\./g' \
              -e 's/!/\\!/g'
          }

          SAFE_EVENT="$(escape "$EVENT")"
          SAFE_ACTOR="$(escape "$ACTOR")"
          SAFE_REPO="$(escape "$REPO")"
          SAFE_BRANCH="$(escape "$BRANCH")"

          MESSAGE=""

          case "$EVENT" in
            push)
              COMMIT_MSG="$(echo "${{ github.event.head_commit.message }}" | head -n 1)"
              SAFE_COMMIT="$(escape "$COMMIT_MSG")"
              MESSAGE="$(printf 'ðŸŸ¢ Push Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s\nðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: %s\nðŸ’¬ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: %s' "$SAFE_REPO" "$SAFE_ACTOR" "$SAFE_BRANCH" "$SAFE_COMMIT")"
              ;;
            pull_request)
              TITLE="${{ github.event.pull_request.title }}"
              ACTION="${{ github.event.action }}"
              SAFE_TITLE="$(escape "$TITLE")"
              SAFE_ACTION="$(escape "$ACTION")"
              MESSAGE="$(printf 'ðŸ“¦ Pull Request: %s\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_ACTION" "$SAFE_TITLE" "$SAFE_ACTOR")"
              ;;
            pull_request_review)
              ACTION="${{ github.event.action }}"
              SAFE_ACTION="$(escape "$ACTION")"
              MESSAGE="$(printf 'ðŸ—£ Review: %s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_ACTION" "$SAFE_ACTOR")"
              ;;
            issues)
              TITLE="${{ github.event.issue.title }}"
              ACTION="${{ github.event.action }}"
              SAFE_TITLE="$(escape "$TITLE")"
              SAFE_ACTION="$(escape "$ACTION")"
              MESSAGE="$(printf 'ðŸ—‚ Issue: %s\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_ACTION" "$SAFE_TITLE" "$SAFE_ACTOR")"
              ;;
            release)
              REL_NAME="${{ github.event.release.name }}"
              SAFE_REL="$(escape "$REL_NAME")"
              MESSAGE="$(printf 'ðŸš€ ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð· Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½:\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_REL" "$SAFE_ACTOR")"
              ;;
            create)
              REF="${{ github.ref }}"
              SAFE_REF="$(escape "$REF")"
              MESSAGE="$(printf 'âœ¨ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ‚ÐºÐ° Ð¸Ð»Ð¸ Ñ‚ÐµÐ³:\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_REF" "$SAFE_ACTOR")"
              ;;
            delete)
              REF="${{ github.ref }}"
              SAFE_REF="$(escape "$REF")"
              MESSAGE="$(printf 'ðŸ—‘ Ð£Ð´Ð°Ð»ÐµÐ½Ð° Ð²ÐµÑ‚ÐºÐ° Ð¸Ð»Ð¸ Ñ‚ÐµÐ³:\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_REF" "$SAFE_ACTOR")"
              ;;
            fork)
              MESSAGE="$(printf 'ðŸ´ ÐÐ¾Ð²Ñ‹Ð¹ Ñ„Ð¾Ñ€Ðº Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ:\n%s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s' "$SAFE_REPO" "$SAFE_ACTOR")"
              ;;
            watch)
              MESSAGE="$(printf 'â­ï¸ ÐÐ¾Ð²Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð° Ð½Ð° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸:\n%s\n\nðŸ‘¤ ÐžÑ‚: %s' "$SAFE_REPO" "$SAFE_ACTOR")"
              ;;
            *)
              MESSAGE="$(printf 'ðŸ“˜ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ: %s\n\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: %s\nðŸ“¦ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: %s' "$SAFE_EVENT" "$SAFE_ACTOR" "$SAFE_REPO")"
              ;;
          esac

          # Ð Ð°ÑÑÑ‹Ð»ÐºÐ° Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ‡Ð°Ñ‚Ð¾Ð²
          if [ -n "$MESSAGE" ]; then
            for CHAT_ID in $TG_CHAT_IDS; do
              echo "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² $CHAT_ID"
              curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                   -d chat_id="$CHAT_ID" \
                   -d parse_mode="MarkdownV2" \
                   -d text="$MESSAGE" >/dev/null
            done
          fi