name: Telegram Notifications

on:
  push:
  pull_request:
  issues:
    types: [opened, closed, reopened, edited]
  pull_request_review:
    types: [submitted]
  release:
    types: [published, created, edited]
  create:
  delete:
  fork:
  watch:
    types: [started]


jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_IDS: ${{ secrets.TG_CHAT_IDS }}
    steps:
      - name: Send Telegram message
        run: |
          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è HTML-—Å–æ–æ–±—â–µ–Ω–∏—è
          escape() {
            echo "$1" | sed \
              -e 's/&/\&amp;/g' \
              -e 's/</\&lt;/g' \
              -e 's/>/\&gt;/g' \
              -e 's/"/\&quot;/g' \
              -e "s/'/\&#39;/g" \
              -e 's/\\/\\\\/g' \
              -e 's/\r//g'
          }

          SAFE_REPO=$(escape "$REPO")
          SAFE_BRANCH=$(escape "$BRANCH")
          SAFE_ACTOR=$(escape "$ACTOR")

          case "$EVENT" in
            push)
              COMMIT_MSG=$(escape "$(echo "${{ github.event.head_commit.message }}" | head -n 1)")
              MESSAGE="üü¢ Push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:\n${SAFE_REPO}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}\nüåø –í–µ—Ç–∫–∞: ${SAFE_BRANCH}\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}"
              ;;
            pull_request)
              TITLE=$(escape "${{ github.event.pull_request.title }}")
              ACTION=$(escape "${{ github.event.action }}")
              MESSAGE="üì¶ Pull Request ${ACTION}:\n${TITLE}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            pull_request_review)
              ACTION=$(escape "${{ github.event.action }}")
              MESSAGE="üó£ Review ${ACTION}:\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            issues)
              TITLE=$(escape "${{ github.event.issue.title }}")
              ACTION=$(escape "${{ github.event.action }}")
              MESSAGE="üóÇ Issue ${ACTION}:\n${TITLE}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            release)
              REL_NAME=$(escape "${{ github.event.release.name }}")
              MESSAGE="üöÄ –ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω:\n${REL_NAME}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            create)
              REF=$(escape "${{ github.ref }}")
              MESSAGE="‚ú® –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ç–∫–∞ –∏–ª–∏ —Ç–µ–≥:\n${REF}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            delete)
              REF=$(escape "${{ github.ref }}")
              MESSAGE="üóë –£–¥–∞–ª–µ–Ω–∞ –≤–µ—Ç–∫–∞ –∏–ª–∏ —Ç–µ–≥:\n${REF}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            fork)
              MESSAGE="üç¥ –ù–æ–≤—ã–π —Ñ–æ—Ä–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:\n${SAFE_REPO}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}"
              ;;
            watch)
              MESSAGE="‚≠êÔ∏è –ù–æ–≤–∞—è –∑–≤–µ–∑–¥–∞ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:\n${SAFE_REPO}\n\nüë§ –û—Ç: ${SAFE_ACTOR}"
              ;;
            *)
              MESSAGE="üìò –°–æ–±—ã—Ç–∏–µ: ${EVENT}\n\nüë§ –ê–≤—Ç–æ—Ä: ${SAFE_ACTOR}\n${SAFE_REPO}"
              ;;
          esac

          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ –≤ HTML-—Ñ–æ—Ä–º–∞—Ç
          if [ -n "$MESSAGE" ]; then
            MESSAGE=$(printf '%s' "$MESSAGE" | sed ':a;N;$!ba;s/\n/<br>/g')
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
          if [ -n "$MESSAGE" ]; then
            for CHAT_ID in $TG_CHAT_IDS; do
              echo "–û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ $CHAT_ID"
              curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                   -d chat_id="$CHAT_ID" \
                   -d parse_mode="HTML" \
                   -d text="$MESSAGE"
            done
          fi
